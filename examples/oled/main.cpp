#include <avr/io.h>
#include <Graphics.h>

#include "OLED.h"
#include "LinkedArray.h"
#include "math.h"

using namespace OCAPI;

#define SSD1306_LCDHEIGHT 32
#define SSD1306_LCDWIDTH 128

static uint8_t buffer[32 * 128 / 8] = {0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x80,0x80,0x80,0x80,0x0,0x0,0xc0,0xc0,0x0,0x0,0x0,0x80,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x11,0x11,0x11,0x11,0xff,0x10,0x10,0x10,0x10,0x10,0x11,0xff,0x10,0x10,0x10,0x10,0x93,0x10,0x30,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x8,0x8,0x4,0x4,0x4,0xff,0x2,0x2,0x2,0x80,0x80,0x40,0x47,0x38,0x70,0x88,0x6,0x1,0x0,0xc0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x3,0x1,0x1,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x1,0x3,0x3,0x3,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0,};

int main() {
    // setup OLED Pins
    Pin cs(PIN_B, 0);
    Pin dc(PIN_B, 1);
    Pin rst(PIN_B, 2);
    Pin mosi(PIN_B, 3);
    Pin sck(PIN_B, 4);
    OLED oled(mosi, sck, dc, rst, cs, SSD1306_LCDWIDTH, SSD1306_LCDHEIGHT);

    // setup oled registers
    oled.begin(false);
    Painter painter(SSD1306_LCDWIDTH, SSD1306_LCDHEIGHT);

    // draw line
    painter.clear();
    painter.drawLine(MakeLine(0,0,100,30));
    oled.paint(painter);

    // draw rect
    painter.clear();
    painter.drawRect(MakeRect(10,3,SSD1306_LCDWIDTH - 20,SSD1306_LCDHEIGHT-6));
    oled.paint(painter);

    // fill rect
    painter.clear();
    painter.drawRect(MakeRect(10,3,SSD1306_LCDWIDTH - 20,SSD1306_LCDHEIGHT-6));
    painter.fillBufferShape();
    oled.paint(painter);

    // fill triangle
    painter.clear();
    painter.drawLine(MakeLine(60,0,10,30));
    painter.drawLine(MakeLine(10,30,100,30));
    painter.drawLine(MakeLine(100,30,60,0));
    painter.fillBufferShape();
    oled.paint(painter);

    //菱形
    painter.clear();
    painter.beginPath();
    painter.moveTo(SSD1306_LCDWIDTH / 2, 1);
    painter.lineTo(SSD1306_LCDWIDTH - 2, SSD1306_LCDHEIGHT / 2 - 1);
    painter.lineTo(SSD1306_LCDWIDTH / 2, SSD1306_LCDHEIGHT-1);
    painter.lineTo(1, SSD1306_LCDHEIGHT / 2);
    painter.closePath();
    painter.strokePath();
    oled.paint(painter);

    painter.clear();
    painter.beginPath();
    painter.moveTo(SSD1306_LCDWIDTH / 2, 0);
    painter.lineTo(SSD1306_LCDWIDTH - 1, SSD1306_LCDHEIGHT / 2);
    painter.lineTo(SSD1306_LCDWIDTH / 2, SSD1306_LCDHEIGHT);
    painter.lineTo(0, SSD1306_LCDHEIGHT / 2);
    painter.closePath();
    painter.fillPath();
    oled.paint(painter);

    painter.clear();
    painter.drawText("HELLO WORLD! I AM OLED SCREEN!");
    oled.paint(painter);

    // stroke rect
    painter.clear();
    painter.drawRect(MakeRect(0,0,SSD1306_LCDWIDTH - 1,SSD1306_LCDHEIGHT - 1));
    oled.paint(painter);

    uint8_t phase = 0;
    while(1) {
        painter.clear();
        painter.drawText("HELLO WORLD!");
        painter.beginPath();
        painter.moveTo(0, SSD1306_LCDHEIGHT / 2);
        for (int16_t i = 0; i < 3; ++i) {
            int16_t y = sin(i + phase) * 10 + SSD1306_LCDHEIGHT / 2;
            if (y > SSD1306_LCDHEIGHT - 1) {
                y = SSD1306_LCDHEIGHT - 1;
            } else if (y < 0) {
                y = 0;
            }
            painter.lineTo(i * SSD1306_LCDWIDTH / 3, y);
        }
        painter.strokePath();
        oled.paint(painter);
        phase += 1;
    }
    return 0;
}
